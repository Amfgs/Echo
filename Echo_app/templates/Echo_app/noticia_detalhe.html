{% extends 'Echo_app/base.html' %}
{% load static %}

{% block title %}{{ noticia.titulo }} | Echo{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" type="text/css" href="{% static 'Echo_app/css/noticia_detalhe.css' %}?v=1.3">
{% endblock %}


{% block content %}

<div class="noticia-container-with-ads">

    <aside class="ad-sidebar ad-left">
        <div class="ad-placeholder">
            (Publicidade Esquerda)
            <br>
            160x600
        </div>
    </aside>

    <article class="noticia-article">
        <p class="voltar-link"><a href="{% url 'dashboard' %}">← Voltar para o Dashboard</a></p>

        <span class="noticia-categoria-tag">{{ noticia.categoria.nome|default:"Geral" }}</span>

        <h1>{{ noticia.titulo }}</h1>

        <div class="metadata">
            <span>Publicado em: {{ noticia.data_publicacao|date:"d/m/Y H:i" }}</span> |
            <span>Por: {{ noticia.autor.username|default:"Autor Desconhecido" }}</span>
        </div>

        <div class="noticia-imagem-principal-wrapper">
            {% if noticia.imagem %}
                <img src="{{ noticia.imagem.url }}" alt="{{ noticia.titulo }}" class="noticia-imagem-principal">
            {% else %}
                <div class="imagem-placeholder">Sem Imagem</div>
            {% endif %}
        </div>

        <div class="imagem-interacoes">
            {% if user.is_authenticated %}
                {% csrf_token %} 

                <button id="btn-curtir"
                        data-url="{% url 'noticia_curtir' noticia_id=noticia.pk %}"
                        class="btn-interacao {% if usuario_curtiu %}curtida-ativa{% endif %}"
                        title="Curtir">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12Z" />
                    </svg>
                    <span>{{ noticia.curtidas_count }}</span>
                    <span class="sr-only">Curtir</span>
                </button>

                <button id="btn-salvar"
                        data-url="{% url 'noticia_salvar' noticia_id=noticia.pk %}"
                        class="btn-interacao {% if usuario_salvou %}salvamento-ativa{% endif %}"
                        title="Salvar">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M17.593 3.322c1.1.128 1.907 1.077 1.907 2.185V21L12 17.25 4.5 21V5.507c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0 1 11.186 0Z" />
                    </svg>
                     <span>{{ noticia.salvamentos_count }}</span>
                     <span class="sr-only">Salvar</span>
                </button>

            {% else %}
                <p class="login-prompt">Faça <a href="{% url 'entrar' %}?next={{ request.path }}">login</a> para interagir.</p>
            {% endif %}
        </div>
        
        <div class="conteudo">
            {{ noticia.conteudo|linebreaksbr }}
        </div>

    </article>

    <aside class="ad-sidebar ad-right">
        <div class="ad-placeholder">
            (Publicidade Direita)
            <br>
            160x600
        </div>
    </aside>

</div> {% endblock content %}


{% block extra_js %}
    {{ block.super }}
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        
        const curtirBtn = document.getElementById('btn-curtir');
        const salvarBtn = document.getElementById('btn-salvar');
        
        const csrftokenInput = document.querySelector('.imagem-interacoes [name=csrfmiddlewaretoken]') || document.querySelector('form [name=csrfmiddlewaretoken]');

        const curtidasCountSpan = document.querySelector('#btn-curtir span:first-of-type');
        const salvamentosCountSpan = document.querySelector('#btn-salvar span:first-of-type');

        if (!csrftokenInput || (!curtirBtn && !salvarBtn)) {
            if (!curtirBtn && !salvarBtn) return;
            if(!csrftokenInput && (curtirBtn || salvarBtn)) return;
            console.warn("CSRF token input not found, interactions might fail.");
            return;
        }

        const csrftoken = csrftokenInput.value;

        // ... (O resto do seu script 'fazerInteracao' vai aqui, sem alterações) ...
        function fazerInteracao(event) {
            const btn = event.currentTarget;
            const url = btn.getAttribute('data-url');
            const tipo = btn.id.includes('curtir') ? 'curtir' : 'salvar';
            const isActive = btn.classList.contains(tipo + '-ativa');

            fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken,
                    'X-Requested-With': 'XMLHttpRequest',
                },
            })
            .then(response => {
                if (response.status === 401 || response.status === 403) { 
                    window.location.href = "{% url 'entrar' %}?next=" + window.location.pathname;
                    return Promise.reject('Unauthorized');
                }
                if (!response.ok) {
                    throw new Error('Erro na rede ou resposta não-OK: ' + response.statusText);
                }
                return response.json();
            })
            .then(data => {
                if (data && data.success) {
                    if (data.status_interacao) {
                        btn.classList.add(tipo + '-ativa');
                        btn.title = (tipo === 'curtir') ? 'Descurtir' : 'Desalvar';
                    } else {
                        btn.classList.remove(tipo + '-ativa');
                        btn.title = (tipo === 'curtir') ? 'Curtir' : 'Salvar';
                    }

                    if (tipo === 'curtir' && curtidasCountSpan) {
                        curtidasCountSpan.textContent = data.nova_contagem;
                    } else if (tipo === 'salvar' && salvamentosCountSpan) {
                        salvamentosCountSpan.textContent = data.nova_contagem;
                    }
                } else if (data) {
                    console.error('Erro retornado pela view:', data.error || 'Erro desconhecido');
                } else {
                    console.error('Resposta JSON inesperada ou vazia.');
                }
            })
            .catch(error => {
                if (error !== 'Unauthorized') {
                    console.error('Erro no Fetch:', error);
                }
            });
        }

        if (curtirBtn) {
            curtirBtn.addEventListener('click', fazerInteracao);
        }
        if (salvarBtn) {
            salvarBtn.addEventListener('click', fazerInteracao);
        }
    });
    </script>
{% endblock %}